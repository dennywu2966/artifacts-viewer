<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Artifacts Viewer</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- CDN Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({ startOnLoad: false, theme: 'neutral', fontFamily: 'Outfit' });
  </script>

  <style>
    :root {
      --bg: #FAFAF9;
      --surface: #FFFFFF;
      --surface-hover: #F5F5F4;
      --border: #E7E5E4;
      --text: #1C1917;
      --text-secondary: #78716C;
      --accent: #007AFF;
      --accent-light: #E0F2FE;
      --success: #22C55E;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
      --shadow-lg: 0 12px 40px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 20px;
      --font: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
    }

    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* Header */
    header {
      height: 60px;
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 24px;
      justify-content: space-between;
      flex-shrink: 0;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--accent), #5856D6);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo-icon svg {
      width: 20px;
      height: 20px;
      color: white;
    }

    .logo-text {
      font-weight: 600;
      font-size: 18px;
      letter-spacing: -0.02em;
    }

    .search-box {
      display: flex;
      align-items: center;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 8px 16px;
      gap: 10px;
      width: 320px;
      transition: all 0.2s ease;
    }

    .search-box:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-light);
    }

    .search-box svg {
      width: 18px;
      height: 18px;
      color: var(--text-secondary);
      flex-shrink: 0;
    }

    .search-box input {
      border: none;
      background: none;
      outline: none;
      font-family: var(--font);
      font-size: 14px;
      width: 100%;
      color: var(--text);
    }

    .search-box input::placeholder {
      color: var(--text-secondary);
    }

    /* Main Layout */
    .main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: rgba(255,255,255,0.6);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-right: 1px solid var(--border);
      overflow-y: auto;
      flex-shrink: 0;
      padding: 16px 12px;
    }

    .sidebar-section {
      margin-bottom: 24px;
    }

    .sidebar-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-secondary);
      padding: 8px 12px;
      margin-bottom: 4px;
    }

    .sidebar-item {
      display: flex;
      align-items: center;
      padding: 12px 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      gap: 12px;
      border-radius: var(--radius-md);
      margin-bottom: 4px;
    }

    .sidebar-item:hover {
      background: var(--surface-hover);
    }

    .sidebar-item.active {
      background: var(--accent-light);
    }

    .sidebar-item.active .file-name {
      color: var(--accent);
      font-weight: 500;
    }

    .file-icon {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .file-icon.pdf { background: #FEE2E2; color: #DC2626; }
    .file-icon.doc { background: #DBEAFE; color: #2563EB; }
    .file-icon.ppt { background: #FEF3C7; color: #D97706; }
    .file-icon.md { background: #F0FDF4; color: #16A34A; }
    .file-icon.mmd { background: #F3E8FF; color: #9333EA; }
    .file-icon.img { background: #E0F2FE; color: #0284C7; }

    .file-info {
      flex: 1;
      min-width: 0;
    }

    .file-name {
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .file-meta {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    /* Content */
    .content {
      flex: 1;
      overflow: auto;
      padding: 32px;
      background: var(--bg);
    }

    .content-inner {
      max-width: 900px;
      margin: 0 auto;
    }

    /* Welcome Screen with Bento Grid */
    .welcome {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      padding: 40px;
    }

    .welcome-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, var(--accent), #5856D6);
      border-radius: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 24px;
      box-shadow: var(--shadow-lg);
    }

    .welcome-icon svg {
      width: 40px;
      height: 40px;
      color: white;
    }

    .welcome h2 {
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 8px;
      letter-spacing: -0.02em;
    }

    .welcome p {
      color: var(--text-secondary);
      font-size: 16px;
    }

    /* Bento Grid for File Types */
    .bento-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-top: 32px;
    }

    .bento-card {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
      cursor: pointer;
      border: 1px solid var(--border);
    }

    .bento-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }

    .bento-card.large {
      grid-column: span 2;
    }

    .bento-card .card-icon {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 16px;
    }

    .bento-card h3 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .bento-card p {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* Beautiful Markdown Render */
    .markdown-preview {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 40px;
      box-shadow: var(--shadow-md);
      line-height: 1.7;
    }

    .markdown-preview h1 {
      font-size: 32px;
      font-weight: 700;
      letter-spacing: -0.03em;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border);
    }

    .markdown-preview h2 {
      font-size: 24px;
      font-weight: 600;
      margin: 32px 0 16px;
      letter-spacing: -0.02em;
    }

    .markdown-preview h3 {
      font-size: 18px;
      font-weight: 600;
      margin: 24px 0 12px;
    }

    .markdown-preview p {
      margin: 16px 0;
      color: #44403C;
    }

    .markdown-preview strong {
      font-weight: 600;
      color: var(--text);
    }

    .markdown-preview code {
      background: #F5F5F4;
      padding: 3px 8px;
      border-radius: 6px;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 14px;
      color: #9333EA;
    }

    .markdown-preview pre {
      background: #1C1917;
      color: #F5F5F4;
      padding: 20px;
      border-radius: var(--radius-md);
      overflow-x: auto;
      margin: 20px 0;
    }

    .markdown-preview pre code {
      background: none;
      padding: 0;
      color: inherit;
    }

    .markdown-preview ul, .markdown-preview ol {
      margin: 16px 0;
      padding-left: 24px;
    }

    .markdown-preview li {
      margin: 8px 0;
    }

    .markdown-preview blockquote {
      border-left: 4px solid var(--accent);
      padding-left: 20px;
      margin: 20px 0;
      color: var(--text-secondary);
      font-style: italic;
    }

    .markdown-preview table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }

    .markdown-preview th, .markdown-preview td {
      border: 1px solid var(--border);
      padding: 12px 16px;
      text-align: left;
    }

    .markdown-preview th {
      background: var(--surface-hover);
      font-weight: 600;
    }

    .markdown-preview a {
      color: var(--accent);
      text-decoration: none;
    }

    .markdown-preview a:hover {
      text-decoration: underline;
    }

    .markdown-preview img {
      max-width: 100%;
      height: auto;
      border-radius: var(--radius-md);
      margin: 16px 0;
      box-shadow: var(--shadow-md);
    }

    .markdown-preview table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      font-size: 14px;
    }

    .markdown-preview th, .markdown-preview td {
      border: 1px solid var(--border);
      padding: 12px 16px;
      text-align: left;
    }

    .markdown-preview th {
      background: var(--surface-hover);
      font-weight: 600;
    }

    .markdown-preview tr:nth-child(even) {
      background: var(--surface-hover);
    }

    .markdown-preview .mermaid {
      background: var(--surface-hover);
      padding: 24px;
      border-radius: var(--radius-md);
      margin: 24px 0;
      text-align: center;
    }

    /* Image Viewer */
    .image-viewer {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 400px;
      padding: 40px;
    }

    .image-viewer img {
      max-width: 100%;
      max-height: 70vh;
      object-fit: contain;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
    }

    /* PDF Viewer */
    .pdf-viewer {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 32px;
      padding: 32px;
    }

    .pdf-page {
      background: var(--surface);
      box-shadow: var(--shadow-md);
      border-radius: var(--radius-sm);
    }

    .pdf-page-label {
      text-align: center;
      font-size: 14px;
      color: var(--text-secondary);
      margin-top: 12px;
    }

    /* Embed Viewer */
    .embed-viewer {
      width: 100%;
      height: calc(100vh - 160px);
      border: none;
      border-radius: var(--radius-lg);
    }

    /* Footer */
    footer {
      height: 44px;
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(20px);
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 24px;
      font-size: 13px;
      color: var(--text-secondary);
      gap: 16px;
      flex-shrink: 0;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
    }

    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 300px;
      gap: 12px;
      color: var(--text-secondary);
    }

    .loading-spinner {
      width: 24px;
      height: 24px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Error */
    .error-viewer {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 300px;
      color: #DC2626;
    }

    .error-viewer svg {
      width: 48px;
      height: 48px;
      margin-bottom: 16px;
    }

    /* Canvas Viewer */
    .canvas-viewer {
      width: 100%;
      height: calc(100vh - 160px);
      overflow: auto;
      position: relative;
      background: #F5F5F4;
      border-radius: var(--radius-lg);
    }

    .canvas-container {
      position: relative;
      min-width: 2000px;
      min-height: 1500px;
      padding: 40px;
    }

    .canvas-node {
      position: absolute;
      border-radius: var(--radius-md);
      padding: 16px;
      box-shadow: var(--shadow-md);
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .canvas-node:hover {
      transform: scale(1.02);
      box-shadow: var(--shadow-lg);
      z-index: 1000;
    }

    .canvas-node.text-node {
      background: var(--surface);
    }

    .canvas-node.file-node {
      background: #E0F2FE;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: #0284C7;
    }

    .canvas-node.link-node {
      background: #F0FDF4;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .canvas-node.link-node a {
      color: #16A34A;
      text-decoration: none;
      font-weight: 500;
    }

    .canvas-node.group-node {
      background: rgba(255,255,255,0.5);
      border: 2px dashed var(--border);
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
    }

    .canvas-node .node-label {
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
      color: var(--text-secondary);
    }

    .canvas-node .node-content {
      font-size: 14px;
      line-height: 1.5;
    }

    .canvas-node .node-content h1,
    .canvas-node .node-content h2,
    .canvas-node .node-content h3 {
      margin: 0 0 8px 0;
      font-size: 16px;
    }

    .canvas-edge {
      position: absolute;
      pointer-events: none;
    }

    .canvas-edge line {
      stroke: var(--border);
      stroke-width: 2;
    }

    .canvas-edge.arrow line {
      marker-end: url(#arrowhead);
    }

    /* Canvas Colors */
    .canvas-color-1 { background: #FEE2E2; border-left: 4px solid #DC2626; }
    .canvas-color-2 { background: #FEF3C7; border-left: 4px solid #D97706; }
    .canvas-color-3 { background: #FEF9C3; border-left: 4px solid #CA8A04; }
    .canvas-color-4 { background: #DCFCE7; border-left: 4px solid #16A34A; }
    .canvas-color-5 { background: #CFFAFE; border-left: 4px solid #0891B2; }
    .canvas-color-6 { background: #F3E8FF; border-left: 4px solid #9333EA; }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo">
        <div class="logo-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
          </svg>
        </div>
        <span class="logo-text">Artifacts</span>
      </div>
      <div class="search-box">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
        </svg>
        <input type="text" placeholder="Search artifacts..." id="searchInput">
      </div>
    </header>

    <div class="main">
      <aside class="sidebar" id="sidebar"></aside>
      <main class="content">
        <div class="content-inner" id="content"></div>
      </main>
    </div>

    <footer>
      <span class="status-dot"></span>
      <span id="status">Ready</span>
      <span id="fileCount">0 artifacts</span>
    </footer>
  </div>

  <script>
    // ==================== Configuration ====================

    // Default categories (used if manifest fails to load)
    const defaultCategories = [
      { id: 'docs', name: 'Documents', extensions: ['pdf', 'doc', 'docx'] },
      { id: 'slides', name: 'Presentations', extensions: ['ppt', 'pptx'] },
      { id: 'markdown', name: 'Markdown', extensions: ['md', 'mdx'] },
      { id: 'diagrams', name: 'Diagrams', extensions: ['mmd', 'mermaid'] },
      { id: 'images', name: 'Images', extensions: ['png', 'jpg', 'jpeg', 'gif', 'webp', 'svg'] },
      { id: 'canvas', name: 'Canvas', extensions: ['canvas'] },
    ];

    // Load from manifest.json
    let fileCategories = defaultCategories;
    let files = [];

    async function loadManifest() {
      try {
        const response = await fetch('manifest.json');
        if (response.ok) {
          const manifest = await response.json();
          if (manifest.directories) fileCategories = manifest.directories;
          if (manifest.files) files = manifest.files;
        }
      } catch (e) {
        console.log('Using default configuration');
      }
    }

    // ==================== Viewers ====================

    const viewers = {
      image: {
        extensions: ['png', 'jpg', 'jpeg', 'gif', 'webp', 'svg'],
        render: (path) => `
          <div class="image-viewer">
            <img src="${path}" alt="Preview" onerror="showError('Failed to load image')">
          </div>
        `
      },

      markdown: {
        extensions: ['md', 'mdx'],
        render: async (path) => {
          try {
            const response = await fetch(path);
            if (!response.ok) throw new Error('File not found');
            const text = await response.text();

            // Calculate base path for relative resources
            const pathParts = path.split('/');
            pathParts.pop(); // Remove filename
            const basePath = pathParts.length > 0 ? pathParts.join('/') + '/' : '';

            let html = marked.parse(text);

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;

            // Fix relative image URLs
            const images = tempDiv.querySelectorAll('img');
            for (const img of images) {
              const src = img.getAttribute('src');
              if (src && !src.startsWith('http') && !src.startsWith('data:')) {
                img.setAttribute('src', basePath + src);
              }
            }

            // Fix relative links to other markdown files
            const links = tempDiv.querySelectorAll('a');
            for (const link of links) {
              const href = link.getAttribute('href');
              if (href && href.endsWith('.md')) {
                // Convert .md links to clickable that loads in viewer
                link.setAttribute('data-md-link', basePath + href);
                link.style.cursor = 'pointer';
                link.addEventListener('click', (e) => {
                  e.preventDefault();
                  previewFile(basePath + href);
                });
              }
            }

            const codeBlocks = tempDiv.querySelectorAll('pre code');
            for (const block of codeBlocks) {
              if (block.classList.contains('language-mermaid') || block.classList.contains('language-mmermaid')) {
                const diagram = block.textContent;
                const container = document.createElement('div');
                container.className = 'mermaid';
                container.textContent = diagram;
                block.parentElement.replaceWith(container);
              }
            }

            setTimeout(async () => {
              try {
                await mermaid.run({ querySelector: '.mermaid' });
              } catch (e) {
                console.error('Mermaid error:', e);
              }
            }, 100);

            return `<div class="markdown-preview">${tempDiv.innerHTML}</div>`;
          } catch (e) {
            return `<div class="error-viewer"><p>Failed to load: ${e.message}</p></div>`;
          }
        }
      },

      pdf: {
        extensions: ['pdf'],
        render: async (path) => {
          try {
            const loadingTask = pdfjsLib.getDocument(path);
            const pdf = await loadingTask.promise;
            let html = '<div class="pdf-viewer">';

            for (let i = 1; i <= pdf.numPages; i++) {
              const page = await pdf.getPage(i);
              const scale = 1.5;
              const viewport = page.getViewport({ scale });

              const canvas = document.createElement('canvas');
              const context = canvas.getContext('2d');
              canvas.height = viewport.height;
              canvas.width = viewport.width;
              canvas.className = 'pdf-page';

              await page.render({ canvasContext: context, viewport }).promise;

              html += `<div class="pdf-page-wrapper">${canvas.outerHTML}<div class="pdf-page-label">Page ${i} of ${pdf.numPages}</div></div>`;
            }
            html += '</div>';
            return html;
          } catch (e) {
            return `<div class="error-viewer"><p>Failed to load PDF: ${e.message}</p></div>`;
          }
        }
      },

      doc: {
        extensions: ['doc', 'docx'],
        render: (path) => {
          const baseUrl = window.location.href.replace(/[^/]*$/, '');
          const fullUrl = baseUrl + path;
          const encodedUrl = encodeURIComponent(fullUrl);
          return `<iframe class="embed-viewer" src="https://docs.google.com/gview?embedded=1&url=${encodedUrl}"></iframe>`;
        }
      },

      ppt: {
        extensions: ['ppt', 'pptx'],
        render: (path) => {
          const baseUrl = window.location.href.replace(/[^/]*$/, '');
          const fullUrl = baseUrl + path;
          const encodedUrl = encodeURIComponent(fullUrl);
          return `<iframe class="embed-viewer" src="https://docs.google.com/gview?embedded=1&url=${encodedUrl}"></iframe>`;
        }
      },

      // Canvas viewer for Obsidian JSON Canvas files
      canvas: {
        extensions: ['canvas'],
        render: async (path) => {
          try {
            const response = await fetch(path);
            if (!response.ok) throw new Error('File not found');
            const canvasData = await response.json();

            const nodes = canvasData.nodes || [];
            const edges = canvasData.edges || [];

            // Calculate bounds
            let minX = 0, minY = 0, maxX = 2000, maxY = 1500;
            nodes.forEach(node => {
              minX = Math.min(minX, node.x);
              minY = Math.min(minY, node.y);
              maxX = Math.max(maxX, node.x + node.width);
              maxY = Math.max(maxY, node.y + node.height);
            });

            // Render edges
            let edgesHtml = '';
            edges.forEach(edge => {
              const fromNode = nodes.find(n => n.id === edge.fromNode);
              const toNode = nodes.find(n => n.id === edge.toNode);
              if (fromNode && toNode) {
                const x1 = fromNode.x + fromNode.width;
                const y1 = fromNode.y + fromNode.height / 2;
                const x2 = toNode.x;
                const y2 = toNode.y + toNode.height / 2;
                const color = edge.color ? `stroke: ${getCanvasColor(edge.color)};` : '';
                const marker = edge.toEnd === 'arrow' ? 'url(#arrow)' : '';
                edgesHtml += `<svg class="canvas-edge" style="position:absolute;left:0;top:0;width:${maxX}px;height:${maxY}px;pointer-events:none;"><defs><marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="${getCanvasColor(edge.color || '1')}"/></marker></defs><line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="${getCanvasColor(edge.color || '1')}" stroke-width="2" marker-end="${marker}"/></svg>`;
              }
            });

            // Render nodes
            let nodesHtml = '';
            nodes.forEach(node => {
              const colorClass = node.color ? `canvas-color-${node.color}` : '';
              const typeClass = `${node.type}-node`;

              let content = '';
              if (node.type === 'text') {
                content = `<div class="node-content">${node.text || ''}</div>`;
              } else if (node.type === 'file') {
                content = `<div class="node-content"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/></svg><span>${node.file?.split('/').pop() || 'File'}</span></div>`;
              } else if (node.type === 'link') {
                content = `<div class="node-content"><a href="${node.url}" target="_blank">${node.url}</a></div>`;
              } else if (node.type === 'group') {
                content = node.label ? `<div class="node-label">${node.label}</div>` : '';
              }

              nodesHtml += `<div class="canvas-node ${typeClass} ${colorClass}" style="left:${node.x}px;top:${node.y}px;width:${node.width}px;height:${node.height}px;">${content}</div>`;
            });

            return `<div class="canvas-viewer"><div class="canvas-container" style="width:${maxX}px;height:${maxY}px;">${edgesHtml}${nodesHtml}</div></div>`;
          } catch (e) {
            return `<div class="error-viewer"><p>Failed to load canvas: ${e.message}</p></div>`;
          }
        }
      }
    };

    function getCanvasColor(color) {
      const colors = {
        '1': '#DC2626',
        '2': '#D97706',
        '3': '#CA8A04',
        '4': '#16A34A',
        '5': '#0891B2',
        '6': '#9333EA'
      };
      return colors[color] || colors['1'];
    }

    // ==================== App Logic ====================

    function getFilesByCategory(categoryId) {
      return files.filter(f => f.category === categoryId);
    }

    function getFileExtension(path) {
      return path.split('.').pop().toLowerCase();
    }

    function findViewer(path) {
      const ext = getFileExtension(path);
      for (const [key, viewer] of Object.entries(viewers)) {
        if (viewer.extensions.includes(ext)) {
          return viewer;
        }
      }
      return null;
    }

    function showWelcome() {
      const categoryIcons = {
        docs: 'üìÑ',
        slides: 'üìä',
        markdown: 'üìù',
        diagrams: 'üîÄ',
        images: 'üñºÔ∏è',
        canvas: 'üé®'
      };

      const categoryDesc = {
        docs: 'PDFs, Word docs',
        slides: 'Presentations',
        markdown: 'Notes & docs',
        diagrams: 'Mermaid diagrams',
        images: 'Photos & graphics',
        canvas: 'Obsidian canvases'
      };

      document.getElementById('content').innerHTML = `
        <div class="welcome">
          <div class="welcome-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
            </svg>
          </div>
          <h2>Your Artifacts</h2>
          <p>Select an artifact from the sidebar to preview</p>

          <div class="bento-grid">
            ${fileCategories.map((cat, idx) => `
              <div class="bento-card ${idx === 0 ? 'large' : ''}" onclick="selectFirstFile('${cat.id}')">
                <div class="card-icon" style="background: ${getCategoryColor(cat.id)}20; color: ${getCategoryColor(cat.id)}">
                  ${categoryIcons[cat.id]}
                </div>
                <h3>${cat.name}</h3>
                <p>${categoryDesc[cat.id]}</p>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function getCategoryColor(cat) {
      const colors = {
        docs: '#DC2626',
        slides: '#D97706',
        markdown: '#16A34A',
        diagrams: '#9333EA',
        images: '#0284C7',
        canvas: '#EC4899'
      };
      return colors[cat] || '#007AFF';
    }

    function selectFirstFile(categoryId) {
      const categoryFiles = getFilesByCategory(categoryId);
      if (categoryFiles.length > 0) {
        previewFile(categoryFiles[0].path);
      }
    }

    function showError(message) {
      document.getElementById('content').innerHTML = `
        <div class="error-viewer">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/><path d="m15 9-6 6m0-6 6 6"/>
          </svg>
          <p>${message}</p>
        </div>
      `;
    }

    function showLoading() {
      document.getElementById('content').innerHTML = `
        <div class="loading">
          <div class="loading-spinner"></div>
          <span>Loading...</span>
        </div>
      `;
    }

    async function previewFile(path) {
      const file = files.find(f => f.path === path);
      if (!file) return;

      document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
      const activeEl = document.querySelector(`[data-path="${path}"]`);
      if (activeEl) activeEl.classList.add('active');

      document.getElementById('status').textContent = file.name;

      const viewer = findViewer(path);
      if (!viewer) {
        showError(`No viewer for .${getFileExtension(path)}`);
        return;
      }

      showLoading();

      try {
        if (viewer.render.constructor.name === 'AsyncFunction') {
          const html = await viewer.render(path);
          document.getElementById('content').innerHTML = html;
        } else {
          const html = viewer.render(path);
          document.getElementById('content').innerHTML = html;
        }
      } catch (e) {
        showError(`Error: ${e.message}`);
      }
    }

    function renderSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.innerHTML = '';

      for (const category of fileCategories) {
        const categoryFiles = getFilesByCategory(category.id);
        if (categoryFiles.length === 0) continue;

        const section = document.createElement('div');
        section.className = 'sidebar-section';

        const title = document.createElement('div');
        title.className = 'sidebar-title';
        title.textContent = category.name;
        section.appendChild(title);

        for (const file of categoryFiles) {
          const item = document.createElement('div');
          item.className = 'sidebar-item';
          item.dataset.path = file.path;
          item.onclick = () => previewFile(file.path);

          const icon = document.createElement('div');
          icon.className = `file-icon ${category.id}`;

          const iconMap = {
            docs: 'üìÑ',
            slides: 'üìä',
            markdown: 'üìù',
            diagrams: 'üîÄ',
            images: 'üñºÔ∏è',
            canvas: 'üé®'
          };
          icon.textContent = iconMap[category.id];

          const info = document.createElement('div');
          info.className = 'file-info';

          const name = document.createElement('div');
          name.className = 'file-name';
          name.textContent = file.name;

          const meta = document.createElement('div');
          meta.className = 'file-meta';
          meta.textContent = file.size;

          info.appendChild(name);
          info.appendChild(meta);
          item.appendChild(icon);
          item.appendChild(info);
          section.appendChild(item);
        }

        sidebar.appendChild(section);
      }

      document.getElementById('fileCount').textContent = `${files.length} artifacts`;
    }

    // Search
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      const items = document.querySelectorAll('.sidebar-item');

      items.forEach(item => {
        const name = item.querySelector('.file-name').textContent.toLowerCase();
        item.style.display = name.includes(query) ? 'flex' : 'none';
      });
    });

    // Init
    loadManifest().then(() => {
      renderSidebar();
      showWelcome();
    });
  </script>
</body>
</html>
